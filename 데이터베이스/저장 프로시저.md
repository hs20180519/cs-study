# 저장 프로시저란?

> 일련의 쿼리를 마치 **하나의 함수**처럼 실행하기 위한 쿼리의 집합

데이터베이스에서 SQL을 통한 작업 중, 하나의 쿼리만으로 원하는 결과 얻을 수 없을 때가 생긴다. 

- 여러 줄의 쿼리문을 한 번의 요청으로 실행한다면?
- 인자만 바뀌고 그 외에는 동일한 로직이 필요하다면?

이럴 때 프로시저(Stored PROCEDURE)를 활용할 수 있다.

![image7](https://github.com/user-attachments/assets/6354f168-cdb1-454d-bd05-09e9fd08e63a)

# 문법 및 사용 예시

### 프로시저 선언

```sql
DELIMITER $$
CREATE PROCEDURE 'TEST_PROC' (
    -- 파라미터 선언
    PARAM_NAME VARCHAR(20),
    PARAM_AGE INT
)
BEGIN
    -- 변수 선언
    DECLARE PARAM_NUM INTEGER;
    
    -- 쿼리문1
    SELECT COUNT(*) + 1
    	INTO PARAM_NUM
        FROM table1;
        
    -- 쿼리문2
    INSERT INTO table1(total_count, user_name, user_age) VALUES(PARAM_NUM, PARAM_NAME, PARAM_AGE);
END $$
DELIMITER ;
```

- `DELIMITER`   : 구분자(;)를 변경함
    - SQL 문의 구분자가 세미콜론이기 때문에, 프로시저 작성을 위해 다른 구분자($$)로 바꿨다가 작성이 끝나면 다시 원래대로 되돌리기 위해 사용
- 파라미터 선언은 프로시저명() 안에서 선언
- SQL문과 변수 선언은 BEGIN ~ END 사이에서 선언
- SELECT 사용 시에는 조회한 컬럼을 반드시 INTO로 변수에 할당

### 프로시저 호출

```sql
CALL TEST_PROC('테스트이름', 21);
```

프로시저 호출 시 흐름

1. DB카탈로그에서 프로시저 이름 찾기
2. SQL문 컴파일
3. 메모리 공간(캐시)에 저장
4. 프로시저 실행

# 장단점

## 장점

1. 성능 향상
2. 유지보수 용이함
3. 보안 강화

### 성능 향상

- *네트워크 트래픽 감소*: 하나의 요청으로 여러 SQL 문을 실행함으로써, 네트워크에 대한 부하를 줄일 수 있다.
- 한 번 컴파일된 후 재사용되므로 매번 SQL 쿼리를 파싱하고 최적화할 필요가 없다.

### 유지보수 용이함

- 소스 코드 측면에서 호스트 언어와 SQL 문장이 분리되어, 수정 시 애플리케이션 코드를 수정할 필요 없이 저장 프로시저만 수정하면 된다.

### 보안 강화

- 사용자 별로 테이블에 권한을 주지 않고, SP에만 접근 권한을 주는 방식으로 보안을 강화한다.

## 단점

1. 호환성
2. 디버깅

### 호환성

- 저장 프로시저는 특정 DBMS에 종속적이므로 타 DBMS 전환 시 호환성 문제가 발생할 수 있다.

### 디버깅

- 저장 프로시저 내 발생하는 오류를 디버깅하는 것이 애플리케이션 코드에 비해 어려울 수 있다.

# 자주 나오는 질문 정리

### 저장 프로시저가 무엇인지 설명해주세요. 그리고 저장 프로시저와 일반 SQL 쿼리의 차이점은 무엇인가요?

저장 프로시저는 데이터베이스에 미리 작성된 SQL 쿼리의 집합으로, 프로시저를 호출하여 반복적으로 사용할 수 있습니다. 반면, 일반 SQL 쿼리는 실행할 때마다 새로 작성해야 합니다. 

그리고 일반 SQL 쿼리는 매번 컴파일 단계가 발생하는 반면, 저장 프로시저의 경우 컴파일된 후 캐싱되어 재사용되므로 더 나은 성능을 기대할 수 있습니다.

### 저장 프로시저의 성능 향상에 대해 설명해주세요.

저장 프로시저는 한 번 컴파일된 후 캐시 메모리에 저장되므로, 반복 실행할 때 SQL 쿼리를 매번 파싱하고 최적화하는 과정을 생략할 수 있어 성능이 향상됩니다. 

또한, 저장 프로시저는 클라이언트-서버 간의 네트워크 트래픽을 줄일 수 있습니다. 여러 개의 SQL 쿼리나 작업을 하나의 프로시저로 묶어 실행함으로써 데이터베이스와의 상호작용이 줄어들고, 대규모 트랜잭션도 더 효율적으로 처리할 수 있습니다.

### 저장 프로시저를 사용할 때 단점이나 문제점은 무엇인가요?

- **DBMS 종속성**: 저장 프로시저는 특정 데이터베이스 관리 시스템에 종속적이어서, 다른 DBMS로 이전할 때 호환성 문제가 발생할 수 있습니다.
- **디버깅과 테스트의 어려움**: 저장 프로시저는 애플리케이션 코드와 달리 디버깅이 어렵고, 독립적인 테스트가 까다로울 수 있습니다.
- **버전 관리의 어려움**: 일반적인 소스 코드처럼 Git 같은 버전 관리 시스템을 쉽게 적용할 수 없으므로 협업 시 불편할 수 있습니다.

### 참조

- [https://ko.wikipedia.org/wiki/저장_프로시저](https://ko.wikipedia.org/wiki/%EC%A0%80%EC%9E%A5_%ED%94%84%EB%A1%9C%EC%8B%9C%EC%A0%80)
- [https://spiderwebcoding.tistory.com/7](https://spiderwebcoding.tistory.com/7)
- [https://devkingdom.tistory.com/323](https://devkingdom.tistory.com/323)
