# 00. 개요

- 프로그램이 실행되기 위해서는 메모리가 필요
- 정적 할당(static allocation): 프로그램이 실행되기 전, 컴파일 시점에 소스 코드를 읽고 메모리 공간을 확보하는 것
- 동적 할당(dynamic allocation)
    - 런타임에 필요한 만큼의 메모리 공간을 확보하는 것
    - heap 영역에 할당

## 동적할당이 필요한 이유

- 메모리는 무한한 자원이 아님
- 그때그때 필요한 만큼의 메모리 공간만 확보하고, 사용한 후에는 해제함으로써 한정된 메모리 공간을 효율적으로 사용하기 위함

## 장점

- 상황에 따라 원하는 크기만큼 메모리 할당 가능
    
    → 경제적
    
- 이미 할당된 메모리의 크기 조정 가능

## 단점

- C언어는 GC가 없으므로, 명시적으로 메모리 해제가 필요함
- 메모리 누수가 일어날 수 있음

# 01. 동적할당 함수

- `#include<stdlib.h>`

## 메모리 할당: `malloc`, `calloc`

- 힙 영역에 필요한 만큼의 메모리 공간을 확보
- 할당된 메모리 공간의 시작 위치를 포인터로 반환

```c
void* malloc(size_t size)
void* calloc(size_t nelem, sizeo_t elsize)
```

### `malloc` vs. `calloc`

```c
int *arr = (int *) malloc(10*sizeof(int));
int *arr = (int *) calloc(10, sizeof(int));
```

매개변수

- `malloc`: 매개변수의 크기만큼 할당
- `calloc`: 두번째 매개변수의 크기를 첫번째 매개변수 개수만큼 할당

**초기화 값**

- `malloc`: 메모리 공간만 할당하므로, 초기화되지 않은 메모리 공간에는 쓰레기 값이 들어 있음
- `calloc`: 할당한 메모리 공간을 0으로 초기화

⇒ 성능은 초기화 단계가 없는 `malloc`이 조금 더 좋음

## 메모리 해제: `free`

- 더 이상 사용하지 않을 메모리 공간을 할당 해제
- 메모리 해제를 통해 해당 메모리 공간을 재활용하고 **메모리 누수를 예방**

### 메모리 누수(memory leak)

- 동적할당한 메모리가 할당해제될 수 없는 상태가 된 것
- 메모리 누수가 반복되면:
    - 결국 시스템의 메모리가 부족해져 운영체제가 메모리 할당에 실패, 프로그램을 종료시킴

```c
int *a = malloc(5); // 5byte 메모리 공간 할당
int *b = malloc(10); // 10byte 메모리 공간 할당

b = a; // b가 a의 주소를 가리킴

free(a); // a 할당 해제
free(b); // a 할당 해제
```

- b는 해제되지 않고 힙 영역에 계속 남아 있음
    
    → 메모리 누수 발생
    

⇒ **할당한 메모리는 반드시 해제**하는 것이 중요

## 메모리 재할당: `realloc`

- 이미 할당되어 있는 메모리 공간의 크기를 변경하여 재할당
- 이전 메모리의 주소는 사라짐

```c
void *realloc(void *ptr, size_t size);
```

- `ptr` 위치에 해당하는 메모리 공간의 블록 크기를 `size`로 조절한다는 의미
    - `ptr == NULL`
        - 재할당하려는 메모리 공간이 선언되어 있지 않은 것
        - `malloc` 또는 `calloc`으로 새로운 메모리 공간을 할당하는 것과 동일하게 동작
    - `size == 0`
        - `ptr` 위치의 메모리 블록 크기를 0으로 만든다는 것
        - 해당 메모리 공간을 할당해제한다는 의미
        - `free` 함수를 호출하는 것과 동일하게 동작
    - `ptr != NULL`
        - `ptr` 위치에 할당되어 있는 메모리의 크기를 `size`로 변경
        - 기존 ptr 블록 다음 블록이 이어서 위치해 있는 경우
            - 기존 위치에서 메모리 공간의 크기를 늘리는 것이 어려우므로
            - 기존 `ptr` 블록의 내용을 유지하며 확장된 메모리 블록을 새로운 주소에 할당
        - 기존 블록보다 작게 할당되는 경우
            - 기존 블록에서 재할당하는 크기만큼의 내용만 유지됨
            - e.g. 기존 8byte 크기의 블록을 4byte로 재할당하는 경우, 재할당하는 블록은 기존 8byte 블록에서 4byte까지의 내용으로 채워짐

# 03. 자주 나오는 질문

## C에서 동적 메모리 할당과 정적 메모리 할당의 차이는 무엇인가요?

정적 메모리 할당은 컴파일 시점에 소스 코드를 읽고 메모리 공간을 확보하는 것이며, 함수가 종료될 시 할당된 메모리가 자동으로 해제됩니다. 스택 영역에 공간을 할당받습니다.

동적 메모리 할당은 런타임에 필요한 만큼의 메모리 공간을 확보하는 것입니다. heap 영역에 공간을 할당받으며, 자동으로 메모리가 해재되지 않으므로 메모리 누수가 발생할 수 있습니다.

## malloc과 calloc의 차이가 무엇인가요?

malloc과 calloc은 메모리를 동적으로 할당할 때 사용되는 함수입니다. malloc은 할당한 메모리를 쓰레기 값으로 채우지만, calloc은 메모리를 0으로 채운다는 차이가 있습니다. 

## C에서 메모리 누수란 무엇이며, 어떻게 방지할 수 있을까요?

C언어에서 메모리를 동적으로 할당하면 해당 메모리는 개발자가 직접 명시적으로 해제하지 않으면 자동으로 해제되지 않습니다. 메모리 누수는 동적할당된 메모리가 해제되지 않아 시스템의 메모리가 점차적으로 고갈되어 가는 상황을 뜻합니다.

메모리 누수를 방지하기 위해서는 동적으로 할당한 메모리가 더 이상 사용되지 않을 경우에 `free` 함수를 통해 반드시 해제해야 합니다.

# 04. 참고자료

[https://velog.io/@saint6839/C언어-동적-메모리-할당-개념-잡기](https://velog.io/@saint6839/C%EC%96%B8%EC%96%B4-%EB%8F%99%EC%A0%81-%EB%A9%94%EB%AA%A8%EB%A6%AC-%ED%95%A0%EB%8B%B9-%EA%B0%9C%EB%85%90-%EC%9E%A1%EA%B8%B0)
