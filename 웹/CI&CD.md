# 00. 개요

## 컴파일과 빌드, 배포

### 컴파일

- 컴파일러가 java, python, javascript와 같은 프로그래밍 언어로 작성한 소스 코드를 기계가 이해할 수 있는 바이너리 코드로 변환하는 과정
- 개발자가 작성한 코드 → 기계어
- .java → .class

### 빌드

- 컴파일된 코드 → 실행 가능한 소프트웨어 산출물
- 빌드 도구: 소스 코드를 실행 가능한 소프트웨어 산출물로 자동 생성하는 프로그램
    - 컴파일, 테스트 정적 분석 등을 사용함
    - 계속해서 늘어나는 라이브러리를 자동으로 추가, 관리, 버전 동기화
    - e.g. Ant, Maven, Gradle, etc.
- 컴파일을 포함하여 war, jar 등의 실행파일을 만드는 과정

### 배포

- 빌드된 파일을 사용자가 접근할 수 있는 환경에 배치시키는 일
- e.g. 빌드파일을 AWS에 올리는 것

⇒ CI/CD 파이프라인을 사용한다면 **자동으로** 빌드, 테스트, 배포 가능

# 01. CI/CD?

- DevOps의 핵심 개념으로, DevOps의 여러 단계를 자동화
- 신속하고 안정적인 소프트웨어 전달을 가능하게 함
- 코드 커밋부터 테스트, 스테이징, 배포 테스트, 배포에 이르기까지의 연결된 일련의 자동화된 단계를 **CI/CD 파이프라인**이라고 함
- 이 과정을 자동화함으로써 개발자는 코드 작성에만 집중할 수 있고, 소프트웨어는 빠르고 안정적으로 배포됨

![Image](https://github.com/user-attachments/assets/55b5b335-ccaa-4a8f-a389-ac60d5fbb6d3)

## 지속적 통합(CI, Continuous Integration)

![Image](https://github.com/user-attachments/assets/98037b23-da10-497c-85ba-bc1b8f560bfa)

- 코드 변경 사항을 공유 리포지토리에 자주 통합(merge)하고 지속적으로 빌드 및 테스트하는 과정
- 빌드/테스트 자동화 프로세스
- e.g. GitHub에 특정 브랜치(master)에 새로운 commit이 push(혹은 merge)될 때마다, 해당 코드를 반영하여 빌드하고 사용자가 미리 만들어둔 테스트 코드를 실행하여 체크하는 과정을 자동화한 것

### CI의 주요 단계

**Code**

- 개발자가 코드를 원격 코드 저장소(e.g. github)에 push

**Build**

- 저장소에 변경된 코드가 올라오면 자동으로 빌드 수행
- 소스코드 컴파일, 기본적인 오류 검사

**Test**

- 빌드에 성공하면, 단위 및 통합 테스트를 실행
- 다른 컴포넌트와도 잘 통합되는지 확인

⇒ Build와 Test는 CI 도구가 자동으로 수행

### 왜 자주 통합해야 할까?

- 많은 코드를 한 번에 머지하면 충돌이 많아지고, 수정에 많은 시간이 소요됨
- 작은 단위로 자주 통합하면 충돌을 미리 발견하고 빠르게 수정 가능
- 코드를 자주 push하고, CI를 통해 지속적으로 테스트함으로써 버그를 조기에 발견할 수 있음

### 장점

- 코드 검증 소요 시간 down
- 개발 편의성 up
- 좋은 코드 퀄리티 유지 가능

## 지속적 제공/배포(CD, Continuous Delivery/Deployment)

- CI 이후에 이어지는 배포 자동화 프로세스
- 지속적 제공: 자동으로 빌드/테스트되면, 운영 서버에 배포하는 것은 수동
- 지속적 배포: 테스트에 성공하면 운영 서버에 자동 배포

⇒ 배포 자동화 여부의 차이

- CI를 통해 문제없는 빌드가 이루어졌다면 CD는 그 빌드를 빠르고 안전하게 사용자에게 제공하는 역할
- 특히 클라우드 기술의 발전으로 빠르고 자주 배포하는 환경이 일반화되면서,
- 사용자 피드백을 빠르게 반영하기 위해 배포 속도가 핵심 경쟁력이 됨

### CD의 주요 단계

**Release**

- 배포 가능한 소프트웨어 패키지를 생성

**Deploy**

- 애플리케이션을 스테이징 또는 프로덕션 환경에 자동 배포
- 서비스 중단 없이 사용자에게 노출

**Operate**

- 운영 상태 모니터링 및 문제 감지
- 서비스 안정성 유지

**+) Deploy vs. Release**

|  | Deploy | Release |
| --- | --- | --- |
| 의미 | 소프트웨어를 서버 등의 환경에 설치하고 실행 가능하게 만드는 과정 | 사용자에게 소프트웨어를 공식적으로 공개하는 과정 |
| 목표 | 환경에 코드 반영(기술적 설치) | 사용자에게 기능 제공(비즈니스 목적) |
| 시점 | 먼저 발생 | 배포 이후, 안정성이 확보된 후 발생 |
| 작업 | 서버에 코드 업로드 + 실행 | 고객에게 새 기능 오픈, 업데이트 안내 |

### 배포 자동화

- 전체 배포 프로세스를 자동으로 수행
- 시간 절약
- 휴먼 에러 감소
- 일관된 배포 품질

## 대표적인 CI/CD 도구

- Github Actions
- Jenkins
    - 완전무료
    - 커뮤니티 활발
    - 플러그인 생태계 good
- Bamboo
    - Atlassian에서 개발: jira와 좋은 호환성
    - 유료
    - 지원 OS: Windows, Mac OS X,
- Travis CI
    - github과 호환성 좋음
    - 부분 무료
- Circle CI
    - github과 연동하기 쉬움
    - 부분 무료
- TeamCity

# 03. 무중단 배포(zero-downtime deployment)

## 중단 배포의 문제점

![Image](https://github.com/user-attachments/assets/8e67d291-620e-4948-9240-6d954dca26d2)


1. 다운타임 발생
    - 24시간 항상 가동되어야 하는 서비스의 경우 문제 발생 가능
2. 무결성 저하
    - 다중 서버 이용 시 서버간 시차로 인한 중복 데이터 발생 가능
3. Rollback 시 중단
    - 배포 시에 문제가 발생하면 Rollback 과정에서 다운타임 발생

⇒ 중단 배포의 문제를 최소화하기 위해 무중단 배포를 사용한다.

## 1. 롤링 배포(Rolling Update Deployment)

- 사용 중인 서버들을 새 버전으로 순차적으로 교체하는 방식

![Image](https://github.com/user-attachments/assets/076e6f05-9f4a-481c-b9f1-79d497a41250)
![Image](https://github.com/user-attachments/assets/97396a4e-ec3f-47b4-a3e7-4f2424cf9d19)


- 부가적인 서버 자원을 사용하지 않고도 배포할 수 있음
- 배포되는 동안에는 평소보다 트래픽 부하가 더 걸림
    - 추가 서버를 하나 더 띄워서 업데이트 중인 서버 때문에 추가적인 트래픽 부하가 걸리지 않도록 하는 방법도 있음
- 신 버전과 구 버전의 호환성이 매우 중요
    - e.g. V1에서는 GET /articles API가 사용되고 있는데 V2에서는 제거된 경우
        - 업데이트 과정에서 V2와 V1 서버가 동시에 존재하게 되는데,
        - 사용자가 GET /articles API를 호출하면 일부는 오류 응답을 받음

## 2. 블루/그린 배포(Blue/Green Deployment)

- 현재 운영중인 환경을 blue, 새 버전의 환경을 green 이라고 함
- Blue와 Green의 인스턴스를 동일하게 구성하여,
- Green의 배포 준비가 완료되면 Blue 환경에서 Green 환경으로 한 번에 전환

![Image](https://github.com/user-attachments/assets/dafc847c-e16d-4253-b456-6ec528400939)

- V2가 배포된 순간부터 로드 밸런서는 모든 트래픽을 V2로 이동
- V1은 마지막 트래픽이 끝나면 종료됨
- 아주 찰나의 순간에만 V1과 V2 서버가 동시에 커져 있음
- 한 번에 버전을 바꾸기 때문에 버전 호환에 대한 문제가 발생하지 않음
- 새로운 버전에 문제가 발생하면 트래픽을 다시 Blue 환경으로 전환하여 빠르게 롤백 가능
- 짧은 시간이지만, 두 버전이 동시에 실행되는 순간이 있기 때문에 추가적인 서버 비용 발생

## 3. 카나리 배포(Canary Deployment)

- 서비스의 모든 새로운 버전을 사용자에게 바로 제공하는 것이 아니라,
- 일부 사용자에게만 제공하여 버전의 안정성과 성능을 검증하는 배포 전략
- 새로운 버전으로 업데이트하면서 발생하는 문제점들을 초기에 확인할 수 있음
- 빠른 롤백 가능
- 초기 단계에서 사용자 피드백 수용 및 반영 가능
- 다른 전략에 비해 비용이 많이 발생

### 단계

1. 평가
    - V2를 제한된 사용자 그룹(카나리 그룹)에 배포
2. 모니터링
    - 카나리 그룹의 피드백과 시스템 메트릭을 모니터링하여 V2의 문제점 파악
3. 확장 배포
    - 앞선 단계에서 문제가 없었을 경우 V2 사용자 그룹을 점진적으로 확대
4. 전체 배포
    - V2를 100% 배포

## 안전하게 서버 종료: Graceful Shutdown

- 무중단 배포 시 기존 인스턴를 종료했을 때 이미 수행중인 작업이 중단될 수 있는 위험이 있음
- 하던 작업을 모두 안전하게 처리한 후 프로세스를 종료하는 것을 우아한 종료(Graceful shutdown)라고 함
- spring boot
    
    ```
    server:
    	shutdown: graceful // 기본 값은 immediate
    ```
    
    - 무한루프를 돌거나 데드락으로 인해 영원히 응답하지 못하는 요청들에 대해서는: shutdown 최대 대기 시간을 지정할 수 있음
    
    		
    
    ```
    spring:
    	lifecycle:
    		timeout-per-shutdown-phase: 5s
    ```
    

# 04. 자주 나오는 질문

## CI/CD에 대해 설명해 주세요.

CI/CD는 지속적 통합과 지속적 배포 또는 전달을 뜻하는 소프트웨어 개발 자동화 방식입니다. CI/CD를 통해 개발부터 배포까지의 과정을 자동화해서 개발 속도를 높이고, 안정적인 배포가 가능해집니다.

먼저 CI는, 여러 개발자가 작업한 코드를 공용 저장소에 자주 병합하고, 그때마다 자동으로 빌드와 테스트를 수행해서 문제를 빠르게 발견하는 과정을 말합니다. 예를 들어 GitHub에 push를 하면, GitHub Actions나 Jenkins 같은 CI 도구가 코드를 자동으로 빌드하고 단위 테스트를 실행하는 식입니다.

CD는 CI 이후 단계로, 테스트를 통과한 코드를 스테이징이나 운영 환경에 자동으로 배포하는 과정입니다. 목적에 따라 Continuous Delivery처럼 사람이 승인 후 배포하거나, Continuous Deployment처럼 완전히 자동으로 운영 환경에 반영되기도 합니다.

## 서버를 무중단 배포하는 방법에 대해 설명해 주세요.

무중단 배포란 서비스를 중단하지 않고 코드나 시스템을 업데이트하는 방법을 말합니다. 대표적인 방법으로는 Rolling, Blue-Green, Canary 가 있습니다.

Rolling 배포는 서버나 인스턴스를 순차적으로 하나씩 업데이트하면서 전체 서비스를 교체하는 방식입니다. 추가 인프라 없이도 무중단 배포가 가능하다는 장점이 있지만, 문제가 발생했을 때는 롤백이 조금 까다로울 수 있습니다.

Blue-Green은 두 개의 동일한 환경 Blue와 Green을 준비해두고 한 번에 트래픽을 전환하는 배포 방식입니다. Green 환경에 새 버전을 배포하고 테스트까지 완료한 뒤 트래픽을 Green으로 전환합니다. 문제가 생기면 다시 Blue로 돌아갈 수 있어서 빠르게 롤백할 수 있습니다.

Canary 배포는 새 버전을 소수 사용자에게만 먼저 배포해서 문제가 없는지 확인한 뒤, 점진적으로 전체 트래픽을 넘기는 방식입니다.

## CI/CD 파이프라인을 구축한 경험이 있나요? 사용한 도구를 설명해 주세요.

# 05. 참고자료

https://www.opsmx.com/blog/what-is-a-ci-cd-pipeline/

https://medium.com/cloud-native-daily/deploying-vs-releasing-understanding-the-difference-473d04abbd2c

https://shinbe.tistory.com/entry/%EC%A4%91%EB%8B%A8%EB%AC%B4%EC%A4%91%EB%8B%A8-%EB%B0%B0%ED%8F%AC

https://velog.io/@hooni_/Blue-Green-%EB%AC%B4%EC%A4%91%EB%8B%A8-%EB%B0%B0%ED%8F%AC

https://velog.io/@byeongju/SpringBoot%EC%9D%98-Graceful-Shutdown
